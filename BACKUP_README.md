\# Инструкция по Восстановлению Базы Данных из Бэкапа



Этот документ описывает процедуру полного восстановления базы данных PostgreSQL из файла бэкапа, созданного сервисом `backup` в `docker-compose.yml`.



\*\*ВАЖНО:\*\* Процедура восстановления полностью \*\*УДАЛЯЕТ\*\* все текущие данные в базе и заменяет их данными из файла бэкапа. Выполняйте ее только в случае серьезного сбоя или потери данных.



\## Где находятся бэкапы?



Бэкапы хранятся в Docker-томе (volume) под названием `tg-bot\_backups`. Каждый день в полночь создается новый файл вида `backup-YYYY-MM-DD-HH-MM-SS.sql.gz`.



\## Процедура восстановления



\### Шаг 1: Остановить работающие сервисы



Чтобы избежать конфликтов во время восстановления, необходимо остановить контейнеры бота и сервиса бэкапов.



```bash

docker-compose stop bot backup

```

Контейнер с базой данных `db` должен продолжать работать.



\### Шаг 2: Найти и скопировать нужный бэкап



1\.  Найдите полный путь к Docker-тому с бэкапами. Запустите команду:

&nbsp;   ```bash

&nbsp;   docker volume inspect tg-bot\_backups

&nbsp;   ```

&nbsp;   В выводе вы увидите `"Mountpoint"`, например: `/var/lib/docker/volumes/tg-bot\_backups/\_data`.



2\.  Перейдите в эту директорию и посмотрите список доступных бэкапов, чтобы выбрать нужный по дате.



3\.  Скопируйте выбранный файл бэкапа (например, `backup-2025-08-10-00-00-00.sql.gz`) в текущую папку вашего проекта для удобства.



\### Шаг 3: Полностью очистить старую базу данных



Для чистого восстановления рекомендуется полностью удалить старый том с данными PostgreSQL.



1\.  Остановите контейнер базы данных:

&nbsp;   ```bash

&nbsp;   docker-compose stop db

&nbsp;   ```

2\.  Удалите том с данными. \*\*ЭТО ДЕЙСТВИЕ НЕОБРАТИМО!\*\*

&nbsp;   ```bash

&nbsp;   docker volume rm tg-bot\_postgres\_data

&nbsp;   ```

3\.  Запустите сервис базы данных заново. Docker автоматически создаст новый, пустой том.

&nbsp;   ```bash

&nbsp;   docker-compose up -d db

&nbsp;   ```

&nbsp;   Подождите 10-15 секунд, чтобы PostgreSQL успел полностью запуститься.



\### Шаг 4: Развернуть бэкап



Мы будем использовать официальный образ `postgres`, чтобы выполнить команду восстановления. Выполните эту длинную команду из корневой папки вашего проекта, где лежит скопированный файл бэкапа.



\*\*Перед запуском:\*\*

\*   Замените `backup-YYYY-MM-DD-HH-MM-SS.sql.gz` на реальное имя вашего файла.

\*   Убедитесь, что вы знаете `db\_user` и `db\_name` из ваших секретных файлов.



```bash

docker run --rm --network tg-bot\_default -v "$(pwd)/backup-YYYY-MM-DD-HH-MM-SS.sql.gz:/backup.sql.gz" postgres:14-alpine sh -c "gunzip -c /backup.sql.gz | psql -h db -U YOUR\_DB\_USER -d YOUR\_DB\_NAME"

```

\*   `--rm`: удалить контейнер после выполнения.

\*   `--network tg-bot\_default`: подключиться к той же сети, где работает `db`.

\*   `-v ...`: "пробросить" ваш файл бэкапа внутрь контейнера.

\*   `gunzip -c ... | psql ...`: распаковать архив и передать его содержимое напрямую в утилиту `psql` для восстановления.

&nbsp;   \*   `-h db`: подключиться к хосту с именем `db` (имя сервиса из `docker-compose`).

&nbsp;   \*   `-U YOUR\_DB\_USER`: использовать имя пользователя из вашего секрета.

&nbsp;   \*   `-d YOUR\_DB\_NAME`: восстанавливать в базу данных с именем из вашего секрета.



Система запросит у вас пароль от базы данных (`db\_password`). Введите его и нажмите Enter. Процесс восстановления может занять от нескольких секунд до нескольких минут в зависимости от размера базы.



\### Шаг 5: Запустить все сервисы



После успешного восстановления можно запускать бота в штатном режиме.



```bash

docker-compose up -d --build

```

Ключ `--build` пересоберет образ бота на случай, если вы вносили изменения в код.



\*\*Восстановление завершено!\*\*

